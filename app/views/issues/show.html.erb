<p id="notice"><%= notice %></p>

<div class="header">
  <div class="section-title">
    <h1><%= @issue.Title %></h1>
  </div>
  <div class="page-actions">
    <% if current_user %>
      <%= link_to new_issue_path, class: 'create-button' do %>
        <span class="add-icon">+</span>
        <span class="createi-button">Create issue</span>
      <% end %>
    <% end %>
  </div>
  <br>
  <div class="page-actions2">
    <% if current_user %>
      <%= button_to issues_url, class: 'back-button' do %>
        <span class="back-button">Back to all issues</span>
      <% end %>
    <% end %>
  </div>
</div>

<div class="main-view">
  <div class="issue-header">
    <span class="issue-id">
      Issue #<%= @issue.id %>
    </span>
    <span class="issue-status">
      <%= @issue.Status %>
    </span>
    <div class="issue-toolbar">
      
      <% if current_user %>
      
          <p class="resol">
            <% if @issue.Status == "Open" || @issue.Status == "New" %>
              <a class="resolved"> <%= link_to 'Resolve', update_status_url(id: @issue.id, status: "Resolved") %> </a>
            <% else %>
              <%= link_to 'Open', update_status_url(id: @issue.id, status: "Open"), class:'open'%>
            <% end %>
          </p>
          
          <div class="dropdown">
              <button class="show-button dropdown-toggle next-to" type="button" data-toggle="dropdown">Workflow
              <span class="caret"></span></button>
              <ul class="dropdown-menu">
                <% Issue.status.each do |status| %>
                  <% if status != @issue.Status %>
                    <%= content_tag(:li, link_to(status, update_status_url(id: @issue.id, status: status))) %>
                  <% end %>
                <% end %>
              </ul>
          </div>
      
          <a href="#" data-toggle="modal" data-target="#attachmodal" class="show-button">Attach</a>

          <a href="/issues/<%= @issue.id %>/edit" class="show-button">Edit</a>
            
          <%= link_to 'Delete', @issue,  method: :delete, class: 'show-button', data: { confirm: 'Are you sure you want to delete this issue?' } %>
      <% end %>
    </div>
  </div>
  
  <div class="issue-main-content">
    
    <div class="issue-info">

      <div class="issue-author">
        <a href="/issues?responsible=<%= @issue.user.name %>">
          
          <!-- AQUI ES POSARIA LA FOTO DE PERFIL --> 
          
          <span title="author-name"><%= @issue.user.name %></span>
        </a>
        created an issue
        <time class="created_at"><%= @issue.created_at.strftime('%Y-%m-%d')
        %></time>
      </div>

      <div class="issue-description">
        <% if !(@issue.Description == "") %>
            <p class="description"><%= @issue.Description %></p>
        <% else %>
            <p class="no-description">No description provided.</p>

        <% end %>
      </div>

      <div class="issue-attachment">
          <% if @issue.attachment.file? %>
              <p>Attachment<a class="attachment-url" href=<%= @issue.attachment.url %> > <%=@issue.attachment.original_filename%></a> last updated <%=time_ago_in_words(Time.at(@issue.attachment.updated_at))%></p>
              <p>Content type <%=@issue.attachment.content_type%></p>
              <% if @issue.attachment.content_type.include? 'image/' %>
                  <div class="attachment-image">
                    <a class="attachment-url" href=<%= @issue.attachment.url %> ><%= image_tag @issue.attachment.url(:thumb) %> </a>
                  </div>
              <%end%>
          <% end %>
      </div>
    
      <!-- BLOC ATTACHMENTS -->
      
      <div class="issue-comments-container">
        
        <h2>Comments (<%= @comments.to_a.size %>)</h2>
        
        <% @issue.comments.each do |comment| %>
          <div>
          <p class="comenter">
            <%= comment.user.name %>
          </p>
         
          <p class="coment">
            <%= comment.body %>
            </br>
            <% if comment.attachment.file? %>
              <div class="attachment-image">
                <%= image_tag comment.attachment.url(:medium) %>
              </div>
            <% end %>         
          </p>
          <%= link_to 'Delete Comment', [comment.issue, comment],
                       method: :delete,
                       data: { confirm: 'Are you sure?' } %>
          </div>
          </br>
        <% end %>
        
        <%= form_with(model: [@issue, @issue.comments.build], local: true) do |form| %>
          <div class="input-group">
            <%= form.text_area :body, placeholder:'What do you want to say?' %>
            <%= form.file_field :attachment %>
          </div>
          <div class="actions">
            <%= form.submit %>
          </div>
        <% end %>
      </div>
      
      <div class="sidebar">
        <div class="issue-attrs">
          <dl>
            <dt>Assigned to</dt>
            <dd>
              <% if !@issue.assignee.nil? %>
              <a href="/issues?assignee=<%= @issue.assignee.name%>">
                <span title="assignee"><%= @issue.assignee.name%></span>
              </a>
              <% else %>
              No one assigned
              <% end %>
            </dd>
          </dl>
          
          <dl>
            <dt>Type</dt>
            <dd class="type with-icon">
              <%= @issue.Type %>
            </dd>
          </dl>
          
          <dl>
            <dt>Priority</dt>
            <dd class="priority with-icon">
              <%= @issue.Priority %>
            </dd>
          </dl>
          
          <dl>
            <dt>Status</dt>
            <dd class="status with-icon">
              <%= @issue.Status %>
            </dd>
          </dl>
          
          <dl>
            <dt>Votes</dt>
            <dd class="votes">
                <%= @issue.Votes %>
                  <% if !Vote.exists?(:issue_id => @issue.id, :user_id => current_user.id) %>
                  <%= link_to 'Vote for this issue', vote_issue_url(id: @issue.id) %>
                  <% else %>
                  <%= link_to 'Remove vote', unvote_issue_url(id: @issue.id) %>
                  <% end %>
              </span>
            </dd>
          </dl>
          
          <dl>
            <dt>Watchers</dt>
            <dd class="watchers">
                <%= @issue.Watchers %>
                  <% if !Watcher.exists?(:issue_id => @issue.id, :user_id => current_user.id) %>
                  <%= link_to 'Watch this issue', watch_issue_url(id: @issue.id, view: "issue") %>
                  <% else %>
                  <%= link_to 'Stop watching', unwatch_issue_url(id: @issue.id, view: "issue") %>
                  <% end %>
              </span>
            </dd>
          </dl>
          
        </div>
      </div>
    </div>
    
  </div>
</div>

<div class="modal fade" id="attachmodal" role="dialog">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Attach a file</h4>
      </div>
      <div class="modal-body">
        <%= form_with(model: @issue, local: true) do |form| %>
          <%= form.file_field :attachment %>
          <%= form.submit %>
        <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>